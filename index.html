<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>X-Wing Scoreboard</title>
    <style>
        #xwsForm {
            padding: 15px;
            margin-top: 20px;
        }
        .total-squad-points-destroyed {
            text-align: right;
            font-weight: bold;
            margin-top: 10px;
        }
        .total-squad-points {
            text-align: right;
            margin-top: 10px;
        }
        .squad-form {
            padding: 15px;
            display: none;
        }
        .squad-1-color {
            background-color: lightcyan;
        }
        .squad-2-color {
            background-color: lightpink;
        }
    </style>
</head>

<body class="bg-dark">
    <br>
    <div class="container-fluid">
        <h2 class="text-light">X-Wing Scoreboard</h2>
        <br>
        <button type="submit" class="btn btn-primary btn-sm btn-info" onclick="showOrHideXWSFormElement()" id="showOrHideXWSFormButton">Hide
            XWS Form</button>
        <a type="submit" class="btn btn-primary btn-sm btn-secondary" href="https://raithos.github.io/"
            target="_blank">ðŸ”— YASB 2.0</a>
        <a type="submit" class="btn btn-primary btn-sm btn-secondary" href="https://tabletop.to/" target="_blank">ðŸ”— TTO</a>
        <br>
        <form id="xwsForm" class="bg-light">
            <div class="form-group">
                <label class="text-dark">Squad 1 XWS</label>
                <input type="text" class="form-control squad-1-color" id="squad1XWS" placeholder="Paste Squad 1 XWS here">
            </div>          
            <div class="form-group">
                <label class="text-dark">Squad 2 XWS</label>
                <input type="text" class="form-control squad-2-color" id="squad2XWS" placeholder="Paste Squad 2 XWS here">
            </div>
            <button type="button" class="btn btn-primary btn-sm btn-secondary" onclick="saveToURL()">Save squad(s) to URL</button>  
            <button type="button" class="btn btn-primary btn-sm btn-danger" onclick="populateScoreboard()">Populate
                Scoreboard</button>
            <br>
            <small>Then mouse-over a pilot in order to see a tool-tip showing that pilot's upgrades</small>
        </form>
        <br>
        <form id="squad1Form" class="squad-form squad-1-color">
        </form>
        <br>
        <form id="squad2Form" class="squad-form squad-2-color">
        </form>
    </div>

    <!-- Optional JavaScript -->
    <script>

        var squad1XWS = "";
        var squad2XWS = "";
        if(window.location.search.indexOf('squad1XWS') != -1) {
            console.log("Importing squad 1 XWS from URL");
            squad1XWS = window.location.search.split("squad1XWS=")[1];
        }
        if(window.location.search.indexOf('squad2XWS') != -1) {
            console.log("Importing squad 2 XWS from URL");
            squad2XWS = squad1XWS.split("&squad2XWS=")[1]
            squad1XWS = squad1XWS.split("&squad2XWS=")[0];
        }        
        document.getElementById("squad1XWS").value = decodeURIComponent(squad1XWS);
        document.getElementById("squad2XWS").value = decodeURIComponent(squad2XWS);

        function saveToURL() {
            var searchText = "";
            if (document.getElementById("squad1XWS").value != "") {
                console.log("Saving squad 1 XWS to URL");
                searchText += "squad1XWS=" + document.getElementById("squad1XWS").value;
            }
            if (document.getElementById("squad2XWS").value != "") {
                console.log("Saving squad 2 XWS to URL");
                searchText += "&squad2XWS=" + document.getElementById("squad2XWS").value;
            }
            window.location.search = searchText;
        }

        function showOrHideXWSFormElement() {
            var element = document.getElementById("xwsForm");
            if ((element.style.display == "") || (element.style.display == "block")) {
                element.style.display = "none";
                document.getElementById("showOrHideXWSFormButton").innerText = "Show XWS Form";
            } else {
                element.style.display = "block";
                document.getElementById("showOrHideXWSFormButton").innerText = "Hide XWS Form";
            }
        }

        function populateScoreboard() {
            document.getElementById("xwsForm").style.display = "none";
            document.getElementById("showOrHideXWSFormButton").innerText = "Show XWS Form";
            populateScoreboardForASquad("squad1XWS", "squad1Form", 1);
            populateScoreboardForASquad("squad2XWS", "squad2Form", 2);
        }

        function populateScoreboardForASquad(squadXWSElementId, squadFormElementId, squadNumber) {
            try {
                var squadJSON = JSON.parse(document.getElementById(squadXWSElementId).value);
                console.log("Squad JSON:", squadJSON);
                var squadFormElement = document.getElementById(squadFormElementId);
                document.getElementById(squadFormElementId).style.display = "block";
                squadFormElement.innerHTML = "<h4>Squad " + squadNumber + "</h4>";
                for (var i = 0; i < squadJSON.pilots.length; i++) {
                    var toolTipText = "No upgrades";
                    if (squadJSON.pilots[i].upgrades) {
                        toolTipText = "Upgrades:\n" + JSON.stringify(squadJSON.pilots[i].upgrades).replace(/"/g, '').replace(/{/g, '').replace(/}/g, '').replace(/\[/g, '').replace(/\],/g, '\n').replace(/\,/g, ', ').replace(/\:/g, ': ').replace("]", "");
                    }
                    var pilotRowHTML = "";
                    pilotRowHTML += "<div class='col'><label class='col-form-label' data-toggle='tooltip' data-placement='top' title='" + toolTipText + "'><b>" + (squadJSON.pilots[i].name.charAt(0).toUpperCase() + squadJSON.pilots[i].name.substring(1)) + "</b> (" + squadJSON.pilots[i].ship + ")" + "</label></div>";
                    pilotRowHTML += "<div class='col'><label class='col-form-label whole-points-input'><b>" + squadJSON.pilots[i].points + "</b> points (whole)</label></div>";
                    pilotRowHTML += "<div class='col'><label class='col-form-label half-points-input'><b>" + Math.ceil(squadJSON.pilots[i].points / 2) + "</b> points (halved)</label></div>";
                    pilotRowHTML += "<div class='col-sm-2'><select class='form-control form-control-sm' onchange='updatePoints(this)'><option value=0>Undamaged</option><option value=0.5>Halved</option><option value=1>Destroyed</option></select></div>";
                    pilotRowHTML += "<div class='col-sm-1' style='display: none;'><label class='col-form-label pilot-points-destroyed'>Points destroyed: <b>0</b></label></div>";
                    var pilotRow = document.createElement("div");
                    pilotRow.classList.add("form-row")
                    pilotRow.innerHTML = pilotRowHTML;
                    squadFormElement.appendChild(pilotRow);
                }
                var totalDestroyed = document.createElement("div");
                totalDestroyed.innerHTML = "Total squad points destroyed: 0";
                totalDestroyed.classList.add("total-squad-points-destroyed")
                totalDestroyed.classList.add("text-danger")
                squadFormElement.appendChild(totalDestroyed);
                var totalPoints = document.createElement("div");
                totalPoints.classList.add("total-squad-points")
                totalPoints.innerHTML = "Total initial squad points: " + squadJSON.points;
                squadFormElement.appendChild(totalPoints);
            } catch (err) {
                console.log("Error with this squad: ", squadXWSElementId, squadFormElementId, err);
            }
        }

        function updatePoints(selectElement) {
            var pilotRowElement = selectElement.parentElement.parentElement;
            var pilotPointsdestroyedElement = pilotRowElement.getElementsByClassName("pilot-points-destroyed")[0];
            console.log(pilotRowElement);
            pilotPointsdestroyedElement.innerHTML = "Points destroyed: <b>" + selectElement.value * parseInt(pilotRowElement.getElementsByClassName("whole-points-input")[0].innerText.split(" ")[0]) + "</b>";
            var totalSquadPointsDestroyedElement = pilotRowElement.parentElement.getElementsByClassName("total-squad-points-destroyed")[0];
            var newTotalPointsDestroyed = 0;
            var pilotPointsElements = pilotRowElement.parentElement.getElementsByClassName("pilot-points-destroyed");
            for (var i = 0; i < pilotPointsElements.length; i++) {
                newTotalPointsDestroyed += parseFloat(pilotPointsElements[i].innerText.replace("Points destroyed: ", ""));
            }
            totalSquadPointsDestroyedElement.innerText = "Total squad points destroyed: " + newTotalPointsDestroyed;
        }
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</body>

</html>